<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>bootheel | Object View</title>
  <link rel="stylesheet" href="../node_modules/fatjs/node_modules/grunt-mocha/node_modules/mocha/mocha.css" />

  <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../bower_components/bootstrap-multiselect/dist/css/bootstrap-multiselect.css" />
  <link rel="stylesheet" href="../bower_components/bootstrap-fileinput/css/fileinput.min.css" />

  <script src="/socket.io/socket.io.js"></script>
  <script src="../bower_components/underscore/underscore-min.js"></script>
  <script src="../bower_components/jsbelt/lib/belt.js"></script>
  <script src="../bower_components/moment/min/moment.min.js"></script>
  <script src="../bower_components/jquery/dist/jquery.min.js"></script>
  <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="../bower_components/bootstrap-multiselect/dist/js/bootstrap-multiselect.js"></script>
  <script src="../bower_components/bootstrap-fileinput/js/fileinput.min.js"></script>
  <script src="../bower_components/bootbox/bootbox.js"></script>
  <script src="../bower_components/backbone/backbone.js"></script>

  <style>
    form {
      padding: 40px;
    }

    .row.header {
      margin-top: 30px;
      padding-top: 20px;
      margin-bottom: 15px;
      border-top: 2px #ccc solid;
    }
    legend {
      border: none;
    }

    textarea {
      resize: none;
    }
    
    * {
      white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
      white-space: -pre-wrap;      /* Opera 4-6 */
      white-space: -o-pre-wrap;    /* Opera 7 */
      white-space: pre-wrap;       /* css-3 */
      word-wrap: break-word;       /* Internet Explorer 5.5+ */
      white-space: -webkit-pre-wrap; /* Newer versions of Chrome/Safari*/
      word-break: break-all;
      white-space: normal;
    }
  </style>

</head>
<body>
  <div id="fixture">
    <form class="form-horizontal">

    </form>
  </div>
  <script src="../lib/bootheel.js" data-cover></script>
  <script>
    var gb = {};

    gb.file1 = {
      'label': 'file1'
    , 'description': 'this is file1'
    , 'file': {}
    , 'details': {}
    };

    gb.view = _$.objectControl({
      'value': gb.file1
    , 'name': 'file1'
    , 'addable': false
    , 'removable': false
    , 'child': {
        'removable': false
      , 'addable': false
      }
    , 'subschemas': {
        'file': {
          'child': {
            'removable': false
          , 'addable': false
          }
        , 'subschemas': {
            'file_path': {
              'removable': false
            , 'addable': false
            , 'readonly': true
            }
          , 'stat': {
              'removable': false
            , 'addable': false
            , 'readonly': true
            , 'child': {
                'removable': false
              , 'addable': false
              , 'readonly': true
              }
            }
          }
        }
      , 'description': {
          '$control': 'textareaControl'
        }
      , 'details': {
          'addable': true
        }
      }
    });

    gb.view.render();

    gb.view.getView('details').$el.after('<hr><label><h4 class="text-warning">Upload new file</h4></label><input name="upload" type="file"></input><hr>');

    gb.view.$('input[name="upload"]').fileinput({
      'showUpload': true
    , 'maxFileCount': 1
    , 'uploadUrl': '/file/create'
    , 'uploadExtraData': function(){
        return {'data': Belt.stringify(gb.view.get())};
      }
    });

    gb.view.$('input[name="upload"]').on('fileuploaded', function(e, data){
      var fd = Belt.get(data, 'response.data');
      if (!fd) return gb.view.setStatus('Error occurred while uploading file');

      gb.view.setStatus();
      $(this).fileinput('reset');
      $(this).fileinput('unlock');
      return gb.view.set(fd);
    });

    gb.view.getView('file').$el.before('<div class="preview"></div>');

    gb.view.renderPreview = function(options){
      var o = options || {}
        , self = this;

      o = _.defaults(o, {
        'path': self.getPath('file.file_path')
      , 'url': '/test/assets/data/'
      });

      if (!o.path) return gb.view.$('.preview').html('');

      var html = '<hr>';
      if (o.path.match(/\.(png|jpg|jpeg|gif|wepb|svg|gifv|bmp)$/i)){
        html += '<img class="img-responsive" style="max-height:600px;" src="' + o.url + o.path + '">'
      } else if (o.path.match(/\.(webm|ogg|mp4)$/i)){
        html += '<video class="img-responsive" style="max-height:600px;" controls>';
          html += '<source src="' + o.url + o.path + '" type="video/' + o.path.match(/\.(webm|ogg|mp4)$/i)[1] + '">';
        html += '</video>';
      } else {
        html += '<iframe class="img-responsive" style="max-height:600px;" src="' + o.url + o.path + '"></iframe>';
      }

      html += '<hr><a href="' + o.url + o.path + '" target="_blank" class="btn btn-primary">View File</a>';
      html += '<hr>'

      return gb.view.$('.preview').html(html);
    };

    gb.view.throtRenderPreview = _.throttle(gb.view.renderPreview, 2000);

    gb.view.on('change', function(data){
      var p = Belt.get(data, 'val.file_path');
      if (p) gb.view.throtRenderPreview();
      return;
    });

    $('form').html(gb.view.$el);

  </script>
</body>
</html>
