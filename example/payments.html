<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>bootheel | Object View</title>
  <link rel="stylesheet" href="../node_modules/fatjs/node_modules/grunt-mocha/node_modules/mocha/mocha.css" />

  <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../bower_components/fontawesome/css/font-awesome.min.css" />
  <link rel="stylesheet" href="../bower_components/bootstrap-multiselect/dist/css/bootstrap-multiselect.css" />
  <link rel="stylesheet" href="../bower_components/bootstrap-fileinput/css/fileinput.min.css" />
  <link rel="stylesheet" href="../bower_components/summernote/dist/summernote.css" />
  <link rel="stylesheet" href="../bower_components/summernote/dist/summernote-bs3.css" />

  <script src="/socket.io/socket.io.js"></script>
  <script src="../bower_components/underscore/underscore-min.js"></script>
  <script src="../bower_components/jsbelt/lib/belt.js"></script>
  <script src="../bower_components/moment/min/moment.min.js"></script>
  <script src="../bower_components/jquery/dist/jquery.min.js"></script>
  <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="../bower_components/bootstrap-multiselect/dist/js/bootstrap-multiselect.js"></script>
  <script src="../bower_components/bootstrap-fileinput/js/fileinput.min.js"></script>
  <script src="../bower_components/bootbox/bootbox.js"></script>
  <script src="../bower_components/backbone/backbone.js"></script>
  <script src="../bower_components/summernote/dist/summernote.min.js"></script>
  <script src="../bower_components/ace/build/src/ace.js"></script>
  <script src="../bower_components/ace/build/src/theme-eclipse.js" type="text/javascript" charset="utf-8"></script>
  <script src="../bower_components/ace/build/src/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://js.braintreegateway.com/v2/braintree.js"></script>

  <style>
    form {
      padding: 40px;
    }

    .row.header {
      margin-top: 30px;
      padding-top: 20px;
      margin-bottom: 15px;
      border-top: 2px #ccc solid;
    }
    legend {
      border: none;
    }

    textarea {
      resize: none;
    }
    
    * {
      white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
      white-space: -pre-wrap;      /* Opera 4-6 */
      white-space: -o-pre-wrap;    /* Opera 7 */
      white-space: pre-wrap;       /* css-3 */
      word-wrap: break-word;       /* Internet Explorer 5.5+ */
      white-space: -webkit-pre-wrap; /* Newer versions of Chrome/Safari*/
      word-break: break-all;
      white-space: normal;
    }
  </style>

</head>
<body>
  <div id="fixture">
    <form class="form-horizontal">

    </form>
  </div>
  <script src="../lib/bootheel.js" data-cover></script>
  <script>
    gb = {};

    gb.createBraintreeClient = function(options, callback){
      var a = Belt.argulint(arguments)
        , self = this;
      a.o = _.defaults(a.o, {

      });
      return $.post('/payment/token/create', function(data){
        var tk = Belt.get(data, 'data.token');

        if (!tk || data.error) return a.cb(new Error(data.error || 'Client token not received'));

        return a.cb(null, new braintree.api.Client({'clientToken': tk}));
      });
    };

    gb.view = _$.objectControl({
      'name': 'Add Credit Card'
    , 'addable': false
    , 'removable': false
    , 'client_token_url': '/payment/token/create'
    , 'value': {
        'number': ''
      , 'cardholderName': ''
      , 'expirationMonth': '01'
      , 'expirationYear': '2015'
      , 'cvv': ''
      }
    , 'child': {
        'removable': false
      }
    , 'subschemas': {
        'expirationMonth': {
          '$control': 'selectControl'
        , 'values': ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12']
        }
      , 'expirationYear': {
          '$control': 'selectControl'
        , 'values': ['2015', '2016', '2017', '2018', '2019', '2020']
        }
      }
    , 'render': {
        'transformer': function(){
          var self = this;
          self.createBraintreeClient(function(err, client){
            if (err) return self.setStatus(err.message);

            self.$client = client;
            return self.getButtons().append(
              _$.button({'class': ['btn', 'btn-info', 'submit']}, 'Submit').render(true)
            );
          });
          return self;
        }
      }
    , 'view': {
        'createBraintreeClient': function(options, callback){
          var a = Belt.argulint(arguments)
            , self = this;
          a.o = _.defaults(a.o, {
            'customer': self.$customer
          });
          return $.post(self.settings.client_token_url, a.o, function(data){
            var tk = Belt.get(data, 'data.token');

            if (!tk || data.error) return a.cb(new Error(data.error || 'Client token not received'));

            return a.cb(null, new braintree.api.Client({'clientToken': tk}));
          });
        }
      , 'submitCard': function(options, callback){
          var a = Belt.argulint(arguments)
            , self = this
            , card = self.get()
            , errors = []
            , _gb = {};

          a.o = _.defaults(a.o, {
            'customer': self.$customer
          });

          if (!card.number) errors.push('Number is required');
          if (!card.cardholderName) errors.push('Cardholder name is required');
          if (!card.expirationMonth) errors.push('Expiration month is required');
          if (!card.expirationYear) errors.push('Expiration year is required');
          if (!card.cvv) errors.push('CVV is required');

          if (_.any(errors)) return self.setStatus(errors);

          self.setStatus();

          return async.waterfall([
            function(cb){

            }
          , function(cb){

            }
          ], function(err){

          }
        }
      }
    , 'events': {
        'click button.submit': function(e){
          e.preventDefault();
          return this.submitCard();
        }
      }
    });
    gb.view.render();


    $('form').append(gb.view.$el);

  </script>
</body>
</html>
