<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>bootheel | Object View</title>
  <link rel="stylesheet" href="../node_modules/fatjs/node_modules/grunt-mocha/node_modules/mocha/mocha.css" />

  <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../bower_components/fontawesome/css/font-awesome.min.css" />
  <link rel="stylesheet" href="../bower_components/bootstrap-multiselect/dist/css/bootstrap-multiselect.css" />
  <link rel="stylesheet" href="../bower_components/bootstrap-fileinput/css/fileinput.min.css" />
  <link rel="stylesheet" href="../bower_components/summernote/dist/summernote.css" />
  <link rel="stylesheet" href="../bower_components/summernote/dist/summernote-bs3.css" />

  <script src="/socket.io/socket.io.js"></script>
  <script src="../bower_components/underscore/underscore-min.js"></script>
  <script src="../bower_components/jsbelt/lib/belt.js"></script>
  <script src="../bower_components/async/lib/async.js"></script>
  <script src="../bower_components/moment/min/moment.min.js"></script>
  <script src="../bower_components/jquery/dist/jquery.min.js"></script>
  <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="../bower_components/bootstrap-multiselect/dist/js/bootstrap-multiselect.js"></script>
  <script src="../bower_components/bootstrap-fileinput/js/fileinput.min.js"></script>
  <script src="../bower_components/bootbox/bootbox.js"></script>
  <script src="../bower_components/backbone/backbone.js"></script>
  <script src="../bower_components/summernote/dist/summernote.min.js"></script>
  <script src="../bower_components/ace/build/src/ace.js"></script>
  <script src="../bower_components/ace/build/src/theme-eclipse.js" type="text/javascript" charset="utf-8"></script>
  <script src="../bower_components/ace/build/src/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://js.braintreegateway.com/v2/braintree.js"></script>

  <style>
    form {
      padding: 40px;
    }

    .row.header {
      margin-top: 30px;
      padding-top: 20px;
      margin-bottom: 15px;
      border-top: 2px #ccc solid;
    }
    legend {
      border: none;
    }

    textarea {
      resize: none;
    }
    
    * {
      white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
      white-space: -pre-wrap;      /* Opera 4-6 */
      white-space: -o-pre-wrap;    /* Opera 7 */
      white-space: pre-wrap;       /* css-3 */
      word-wrap: break-word;       /* Internet Explorer 5.5+ */
      white-space: -webkit-pre-wrap; /* Newer versions of Chrome/Safari*/
      word-break: break-all;
      white-space: normal;
    }
  </style>

</head>
<body>
  <div id="fixture">
    <form class="form-horizontal">

    </form>
  </div>
  <script src="../lib/bootheel.js" data-cover></script>
  <script>
    gb = {};

    gb.account = _$.paymentAccountControl({
      'name': 'Payment Account'
    , 'addable': false
    , 'removable': false
    , 'child': {
        'removable': false
      , 'addable': false
      , 'readonly': true
      }
    });

    //gb.creditCard = _$.creditCardControl();

    /*gb.creditCard = _$.objectControl({
      'name': 'Add Credit Card'
    , 'addable': false
    , 'removable': false
    , 'client_token_url': '/payment/token/create'
    , 'create_account_url': '/payment/account/create'
    , 'value': {
        'number': ''
      , 'cardholderName': ''
      , 'expirationMonth': '01'
      , 'expirationYear': '2015'
      , 'cvv': ''
      }
    , 'child': {
        'removable': false
      }
    , 'subschemas': {
        'expirationMonth': {
          '$control': 'selectControl'
        , 'values': ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12']
        }
      , 'expirationYear': {
          '$control': 'selectControl'
        , 'values': ['2015', '2016', '2017', '2018', '2019', '2020']
        }
      }
    , 'render': {
        'transformer': function(){
          var self = this;
          self.createBraintreeClient(function(err, client){
            if (err) return self.setStatus(err.message);

            self.$client = client;
            return self.getButtons().append(
              _$.button({'class': ['btn', 'btn-info', 'submit']}, 'Submit').render(true)
            );
          });
          return self;
        }
      }
    , 'view': {
        'createBraintreeClient': function(options, callback){
          var a = Belt.argulint(arguments)
            , self = this;
          a.o = _.defaults(a.o, {
            'customer': self.$customer
          });
          return $.post(self.settings.client_token_url, a.o, function(data){
            var tk = Belt.get(data, 'data.token');

            if (!tk || data.error) return a.cb(new Error(data.error || 'Client token not received'));

            self.$token = tk;

            return a.cb(null, new braintree.api.Client({
              'clientToken': tk
            }));
          });
        }
      , 'submitCard': function(options, callback){
          var a = Belt.argulint(arguments)
            , self = this
            , card = self.get()
            , errors = []
            , _gb = {};

          a.o = _.defaults(a.o, {
            'customer': self.$customer
          });

          if (!self.$client) errors.push('Cannot reach payment processor');

          if (!card.number) errors.push('Number is required');
          if (!card.cardholderName) errors.push('Cardholder name is required');
          if (!card.expirationMonth) errors.push('Expiration month is required');
          if (!card.expirationYear) errors.push('Expiration year is required');
          if (!card.cvv) errors.push('CVV is required');

          if (_.any(errors)) return self.setStatus(errors);

          self.setStatus();

          return async.waterfall([
            function(cb){
              return self.$client.tokenizeCard(card, Belt.cs(cb, _gb, 'paymentMethodNonce', 1, 0));
            }
          , function(cb){
              return $.post(self.settings.create_account_url, Belt.extend({}, _gb, a.o), Belt.cs(cb, _gb, 'res', 0));
            }
          ], function(err){
            if (!err && _gb.res.error) err = new Error(_gb.res.error);

            if (!err) self.set(self.settings.value);

            return a.cb(err, _gb.res.data);
          });
        }
      }
    , 'events': {
        'click button.submit': function(e){
          e.preventDefault();
          var self = this;
          return self.submitCard(function(err, data){
            if (err) return self.setStatus(err.message);

            self.setStatus();

            /*var ccard = _$.textControl({'label': '<img src="' + data.creditCards[0].imageUrl + '">'
            , 'value': data.creditCards[0].maskedNumber, 'readonly': true, 'removable': true});
            ccard.render();

            return self.$el.after('<hr>', ccard.$el);*/
/*            return gb.account.set(data);
          });
        }
      }
    });*/

    /*gb.paypal = _$.view({
      'tag': 'div'
    , 'layout': ['control']
    , 'views': {
        'control': _$.div({'class': 'col-xs-12'}).div({'class': 'row'}, [
          _$.div({'class': 'col-xs-2'}).legend({'class': 'text-primary'}, 'Add PayPal')
        , _$.div({'class': 'col-xs-10'}).div({'class': 'paypal'})
        ])
      }
    , 'class': ['row', 'header']
    , 'client_token_url': '/payment/token/create'
    , 'create_account_url': '/payment/account/create'
    , 'render': {
        'transformer': function(){
          return this.createBraintreeClient();
        }
      }
    , 'view': {
        'createBraintreeClient': function(options, callback){
          var a = Belt.argulint(arguments)
            , self = this;
          a.o = _.defaults(a.o, {
            'customer': self.$customer
          });
          return $.post(self.settings.client_token_url, a.o, function(data){
            var tk = Belt.get(data, 'data.token');

            if (!tk || data.error) return a.cb(new Error(data.error || 'Client token not received'));

            self.$token = tk;

            braintree.setup(tk, 'paypal', Belt.extend({
              'container': self.$('.paypal')
            , 'onSuccess': function(nonce, email, addr){
                return self.submitPaypal({
                  'paymentMethodNonce': nonce
                });
              }
            }, self.settings.paypal || {}));
            return a.cb()
          });
        }
      , 'submitPaypal': function(options, callback){
          var a = Belt.argulint(arguments)
            , self = this
            , card = self.get()
            , errors = []
            , _gb = {};

          a.o = _.defaults(a.o, {
            'customer': self.$customer
          });

          //self.setStatus();

          return async.waterfall([
            function(cb){
              return $.post(self.settings.create_account_url, Belt.extend({}, _gb, a.o), Belt.cs(cb, _gb, 'res', 0));
            }
          ], function(err){
            if (!err && _gb.res.error) err = new Error(_gb.res.error);

            return gb.account.set(_gb.res.data);
          });
        }
      }
    });*/

    gb.account.render();
    $('form').append(gb.account.$el);

    //gb.creditCard.render();
    //$('form').append(gb.creditCard.$el);

    //gb.paypal.render();
    //$('form').append(gb.paypal.$el);

  </script>
</body>
</html>
